{% extends 'base.html' %}
{% load crispy_forms_tags %} {% load static %}
{% block title %} Project Form {% endblock title %}

{% block main %}
  <div class="row py-3">
    <div class="col-md-12 m-auto">
      <div class="card shadow">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="card-title fw-semibold">
            {% if object %}
              Update Project
            {% else %}
              Add Project
            {% endif %}
          </h3>
          <a class="btn btn-dark" href="{% url "paceapp:university_list" %}">Go Back</a>
        </div>
        <div class="card-body">
          <form action="" method="post" id="university_form" enctype="multipart/form-data">
            {% csrf_token %}
            {% crispy form %}
          </form>
        </div>
        <div class="card-footer">
          <button type="submit" class="btn btn-primary float-end" form="university_form">Save</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block inline_javascript %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const countrySelect = document.getElementById('id_country');
      const campusSelect = document.getElementById('id_campus');
      const applicationAcceptSelect = document.getElementById('id_application_accepting_from');
      const boardsSelect = document.getElementById('id_boards');
      const statesSelect = document.getElementById('id_states');
      const otherCountriesSelect = document.getElementById('id_application_accepting_from');

      function fetchOptions(url, selectElement) {
        let countryId = countrySelect.value;
        if (countryId) {
          fetch(url + '?country_id=' + countryId)
            .then(response => response.json())
            .then(optionsData => {
              selectElement.innerHTML = ''; // Clear previous options
              optionsData.forEach(function (option) {
                var optionEl = document.createElement('option');
                optionEl.value = option.id;
                optionEl.text = option.name;
                selectElement.appendChild(optionEl);
              });
            })
            .catch(error => console.error('Error fetching options:', error));
        } else {
          selectElement.innerHTML = ''; // Clear options if no country is selected
        }
      }

      countrySelect.addEventListener('change', function () {
        fetchOptions('/ajax/get-campus/', campusSelect);
        fetchOptions('/ajax/get-other-countries/', otherCountriesSelect);
      });

      function updateBoardsAndStates(selectedCountries) {
        let url = "{% url 'paceapp:ajax_get_board_or_state' %}";

        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}', // Replace with actual csrf token
          },
          body: JSON.stringify({countries: selectedCountries}),
        })
          .then(response => response.json())
          .then(responseData => {
            const states = responseData.states;
            const boards = responseData.boards;

            boardsSelect.innerHTML = '';
            boards.forEach(function (option) {
              var optionEl = document.createElement('option');
              optionEl.value = option.id;
              optionEl.text = option.name;
              boardsSelect.appendChild(optionEl);
            });

            statesSelect.innerHTML = '';
            states.forEach(function (option) {
              var optionEl = document.createElement('option');
              optionEl.value = option.id;
              optionEl.text = option.name;
              statesSelect.appendChild(optionEl);
            });
          })
          .catch(error => {
            console.error('Error:', error);
            // Handle errors during the request
          });
      }

      applicationAcceptSelect.addEventListener('change', function () {
        const selectedCountries = Array.from(applicationAcceptSelect.options)
          .filter(option => option.selected)
          .map(option => parseInt(option.value));
        updateBoardsAndStates(selectedCountries);
      });

    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const commissionFrequencySelect = document.getElementById('id_commission_frequency');
      const partially1Field = document.querySelector('[for="id_partially_1"]').closest('.col-md-4');
      const partially2Field = document.querySelector('[for="id_partially_2"]').closest('.col-md-4');

      function togglePartialFields() {
        if (commissionFrequencySelect.value === 'partially') {
          partially1Field.style.display = '';
          partially2Field.style.display = '';
        } else {
          partially1Field.style.display = 'none';
          partially2Field.style.display = 'none';
        }
      }
      
      togglePartialFields();
      commissionFrequencySelect.addEventListener('change', togglePartialFields);
    });
  </script>


{% endblock %}
